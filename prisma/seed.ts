// prisma/seed.ts
import { PrismaClient } from "@prisma/client";
import bcrypt from "bcrypt";

const prisma = new PrismaClient();

async function main() {
  console.log(`üå± Starting database seeding...`);

  // Hash password for all demo users
  const hashedPassword = await bcrypt.hash("password123", 10);

  try {
    // Clean existing data (in correct order due to foreign key constraints)
    console.log("üßπ Cleaning existing data...");
    await prisma.flashcardProgress.deleteMany();
    await prisma.flashcard.deleteMany();
    await prisma.flashcardSet.deleteMany();
    await prisma.membership.deleteMany();
    await prisma.course.deleteMany();
    await prisma.session.deleteMany();
    await prisma.account.deleteMany();
    await prisma.user.deleteMany();

    // Create demo users
    console.log("üë• Creating demo users...");
    const users = await Promise.all([
      prisma.user.create({
        data: {
          email: "alice@repit.com",
          password: hashedPassword,
          name: "Alice Johnson",
          createdAt: new Date("2024-01-15"),
          updatedAt: new Date("2024-07-15"),
        },
      }),
      prisma.user.create({
        data: {
          email: "bob@repit.com",
          password: hashedPassword,
          name: "Bob Smith",
          createdAt: new Date("2024-02-10"),
          updatedAt: new Date("2024-07-14"),
        },
      }),
      prisma.user.create({
        data: {
          email: "charlie@repit.com",
          password: hashedPassword,
          name: "Charlie Brown",
          createdAt: new Date("2024-03-05"),
          updatedAt: new Date("2024-07-13"),
        },
      }),
      prisma.user.create({
        data: {
          email: "diana@repit.com",
          password: hashedPassword,
          name: "Diana Prince",
          createdAt: new Date("2024-04-01"),
          updatedAt: new Date("2024-07-12"),
        },
      }),
    ]);

    console.log(`‚úÖ Created ${users.length} users`);

    // Create courses
    console.log("üéì Creating courses...");
    const courses = await Promise.all([
      prisma.course.create({
        data: {
          name: "English for Beginners",
          description: "Start your English learning journey with basic vocabulary and grammar",
          createdAt: new Date("2024-01-01"),
          updatedAt: new Date("2024-07-01"),
        },
      }),
      prisma.course.create({
        data: {
          name: "Business English Mastery",
          description: "Professional English skills for the workplace",
          createdAt: new Date("2024-02-01"),
          updatedAt: new Date("2024-07-01"),
        },
      }),
      prisma.course.create({
        data: {
          name: "Advanced Conversation",
          description: "Improve your fluency with advanced speaking techniques",
          createdAt: new Date("2024-03-01"),
          updatedAt: new Date("2024-07-01"),
        },
      }),
    ]);

    console.log(`‚úÖ Created ${courses.length} courses`);

    // Create memberships
    console.log("üéØ Creating course memberships...");
    const memberships = [
      // Alice - member of beginners and business
      { userId: users[0].id, courseId: courses[0].id, role: "member" },
      { userId: users[0].id, courseId: courses[1].id, role: "member" },
      
      // Bob - admin of beginners, member of advanced
      { userId: users[1].id, courseId: courses[0].id, role: "admin" },
      { userId: users[1].id, courseId: courses[2].id, role: "member" },
      
      // Charlie - member of all courses
      { userId: users[2].id, courseId: courses[0].id, role: "member" },
      { userId: users[2].id, courseId: courses[1].id, role: "member" },
      { userId: users[2].id, courseId: courses[2].id, role: "member" },
      
      // Diana - admin of business and advanced
      { userId: users[3].id, courseId: courses[1].id, role: "admin" },
      { userId: users[3].id, courseId: courses[2].id, role: "admin" },
    ];

    for (const membership of memberships) {
      await prisma.membership.create({ data: membership });
    }

    console.log(`‚úÖ Created ${memberships.length} memberships`);

    // Create flashcard sets with flashcards
    console.log("üìö Creating flashcard sets...");

    // Alice's flashcard sets
    const aliceSet1 = await prisma.flashcardSet.create({
      data: {
        title: "Essential Daily Vocabulary",
        description: "Common words used in everyday conversations",
        userId: users[0].id,
        cardCount: 0,
        createdAt: new Date("2024-01-20"),
        updatedAt: new Date("2024-07-10"),
        flashcards: {
          create: [
            { question: "Hello", answer: "Xin ch√†o", example: "Hello, how are you today?" },
            { question: "Thank you", answer: "C·∫£m ∆°n", example: "Thank you for your help!" },
            { question: "Please", answer: "Xin l·ªói / L√†m ∆°n", example: "Please pass me the salt." },
            { question: "Sorry", answer: "Xin l·ªói", example: "Sorry, I'm late!" },
            { question: "Excuse me", answer: "Xin l·ªói", example: "Excuse me, where is the bathroom?" },
            { question: "Good morning", answer: "Ch√†o bu·ªïi s√°ng", example: "Good morning, everyone!" },
            { question: "Good night", answer: "Ch√∫c ng·ªß ngon", example: "Good night, see you tomorrow." },
            { question: "How much?", answer: "Bao nhi√™u ti·ªÅn?", example: "How much does this cost?" },
            { question: "Where", answer: "·ªû ƒë√¢u", example: "Where do you live?" },
            { question: "When", answer: "Khi n√†o", example: "When will you arrive?" },
          ]
        }
      },
    });

    const aliceSet2 = await prisma.flashcardSet.create({
      data: {
        title: "Food and Dining",
        description: "Vocabulary related to food, restaurants, and dining experiences",
        userId: users[0].id,
        cardCount: 0,
        createdAt: new Date("2024-02-01"),
        updatedAt: new Date("2024-07-08"),
        flashcards: {
          create: [
            { question: "Restaurant", answer: "Nh√† h√†ng", example: "Let's go to a nice restaurant for dinner." },
            { question: "Menu", answer: "Th·ª±c ƒë∆°n", example: "Can I see the menu, please?" },
            { question: "Order", answer: "ƒê·∫∑t m√≥n", example: "I would like to order pizza." },
            { question: "Delicious", answer: "Ngon", example: "This cake is delicious!" },
            { question: "Spicy", answer: "Cay", example: "I don't like spicy food." },
            { question: "Sweet", answer: "Ng·ªçt", example: "This dessert is too sweet for me." },
            { question: "Fresh", answer: "T∆∞∆°i", example: "These vegetables are very fresh." },
            { question: "Bill", answer: "H√≥a ƒë∆°n", example: "Can we have the bill, please?" },
          ]
        }
      },
    });

    // Bob's flashcard sets
    const bobSet1 = await prisma.flashcardSet.create({
      data: {
        title: "Business English Essentials",
        description: "Key vocabulary for professional communication",
        userId: users[1].id,
        cardCount: 0,
        createdAt: new Date("2024-02-15"),
        updatedAt: new Date("2024-07-12"),
        flashcards: {
          create: [
            { question: "Meeting", answer: "Cu·ªôc h·ªçp", example: "We have a meeting at 2 PM." },
            { question: "Presentation", answer: "B√†i thuy·∫øt tr√¨nh", example: "I need to prepare my presentation." },
            { question: "Deadline", answer: "H·∫°n ch√≥t", example: "The deadline for this project is Friday." },
            { question: "Report", answer: "B√°o c√°o", example: "Please submit your report by Monday." },
            { question: "Budget", answer: "Ng√¢n s√°ch", example: "We need to discuss the budget for next quarter." },
            { question: "Client", answer: "Kh√°ch h√†ng", example: "Our client is very satisfied with our service." },
            { question: "Schedule", answer: "L·ªãch tr√¨nh", example: "What's your schedule for tomorrow?" },
            { question: "Colleague", answer: "ƒê·ªìng nghi·ªáp", example: "My colleague will help you with this task." },
            { question: "Professional", answer: "Chuy√™n nghi·ªáp", example: "She always maintains a professional attitude." },
            { question: "Negotiate", answer: "ƒê√†m ph√°n", example: "We need to negotiate the contract terms." },
          ]
        }
      },
    });

    const bobSet2 = await prisma.flashcardSet.create({
      data: {
        title: "Travel English",
        description: "Essential phrases for traveling and tourism",
        userId: users[1].id,
        cardCount: 0,
        createdAt: new Date("2024-03-01"),
        updatedAt: new Date("2024-07-09"),
        flashcards: {
          create: [
            { question: "Airport", answer: "S√¢n bay", example: "I'll pick you up at the airport." },
            { question: "Flight", answer: "Chuy·∫øn bay", example: "My flight is delayed by two hours." },
            { question: "Hotel", answer: "Kh√°ch s·∫°n", example: "We're staying at a hotel near the beach." },
            { question: "Passport", answer: "H·ªô chi·∫øu", example: "Don't forget to bring your passport." },
            { question: "Luggage", answer: "H√†nh l√Ω", example: "My luggage is too heavy." },
            { question: "Tourist", answer: "Du kh√°ch", example: "This area is popular with tourists." },
            { question: "Map", answer: "B·∫£n ƒë·ªì", example: "Do you have a map of the city?" },
            { question: "Directions", answer: "Ch·ªâ ƒë∆∞·ªùng", example: "Can you give me directions to the museum?" },
          ]
        }
      },
    });

    // Charlie's flashcard sets  
    const charlieSet1 = await prisma.flashcardSet.create({
      data: {
        title: "Academic English",
        description: "Vocabulary for academic writing and research",
        userId: users[2].id,
        cardCount: 0,
        createdAt: new Date("2024-03-10"),
        updatedAt: new Date("2024-07-11"),
        flashcards: {
          create: [
            { question: "Research", answer: "Nghi√™n c·ª©u", example: "I'm doing research on climate change." },
            { question: "Analysis", answer: "Ph√¢n t√≠ch", example: "The analysis shows interesting results." },
            { question: "Hypothesis", answer: "Gi·∫£ thuy·∫øt", example: "Our hypothesis was proven correct." },
            { question: "Evidence", answer: "B·∫±ng ch·ª©ng", example: "We need more evidence to support this theory." },
            { question: "Conclusion", answer: "K·∫øt lu·∫≠n", example: "In conclusion, the experiment was successful." },
            { question: "Reference", answer: "Tham kh·∫£o", example: "Please include all references in your paper." },
            { question: "Academic", answer: "H·ªçc thu·∫≠t", example: "She has an excellent academic record." },
            { question: "Scholar", answer: "H·ªçc gi·∫£", example: "He is a respected scholar in his field." },
            { question: "Thesis", answer: "Lu·∫≠n √°n", example: "I'm writing my master's thesis." },
            { question: "Publication", answer: "Xu·∫•t b·∫£n", example: "His research was accepted for publication." },
          ]
        }
      },
    });

    // Diana's flashcard sets
    const dianaSet1 = await prisma.flashcardSet.create({
      data: {
        title: "Technology Terms",
        description: "Modern technology and digital vocabulary",
        userId: users[3].id,
        cardCount: 0,
        createdAt: new Date("2024-04-05"),
        updatedAt: new Date("2024-07-13"),
        flashcards: {
          create: [
            { question: "Software", answer: "Ph·∫ßn m·ªÅm", example: "This software is very user-friendly." },
            { question: "Hardware", answer: "Ph·∫ßn c·ª©ng", example: "We need to upgrade our hardware." },
            { question: "Internet", answer: "Internet", example: "The internet connection is very fast here." },
            { question: "Website", answer: "Trang web", example: "Our company's website needs updating." },
            { question: "Database", answer: "C∆° s·ªü d·ªØ li·ªáu", example: "All customer information is stored in the database." },
            { question: "Application", answer: "·ª®ng d·ª•ng", example: "This mobile application is very popular." },
            { question: "Security", answer: "B·∫£o m·∫≠t", example: "Online security is very important." },
            { question: "Download", answer: "T·∫£i xu·ªëng", example: "You can download the app for free." },
            { question: "Upload", answer: "T·∫£i l√™n", example: "Please upload your documents to the cloud." },
            { question: "Digital", answer: "K·ªπ thu·∫≠t s·ªë", example: "We live in a digital age." },
          ]
        }
      },
    });

    // Update card counts for all sets
    const allSets = [aliceSet1, aliceSet2, bobSet1, bobSet2, charlieSet1, dianaSet1];
    
    for (const set of allSets) {
      const cardCount = await prisma.flashcard.count({
        where: { setId: set.id }
      });
      
      await prisma.flashcardSet.update({
        where: { id: set.id },
        data: { cardCount }
      });
    }

    console.log(`‚úÖ Created ${allSets.length} flashcard sets with flashcards`);

    // Create progress records
    console.log("üìà Creating learning progress...");
    const progressData = [
      // Alice's progress
      { userId: users[0].id, setId: aliceSet1.id, learned: 7, lastReviewed: new Date("2024-07-10") },
      { userId: users[0].id, setId: aliceSet2.id, learned: 5, lastReviewed: new Date("2024-07-08") },
      
      // Bob's progress  
      { userId: users[1].id, setId: bobSet1.id, learned: 8, lastReviewed: new Date("2024-07-12") },
      { userId: users[1].id, setId: bobSet2.id, learned: 6, lastReviewed: new Date("2024-07-09") },
      
      // Charlie's progress
      { userId: users[2].id, setId: charlieSet1.id, learned: 4, lastReviewed: new Date("2024-07-11") },
      
      // Diana's progress
      { userId: users[3].id, setId: dianaSet1.id, learned: 9, lastReviewed: new Date("2024-07-13") },
      
      // Cross-user progress (users studying others' public sets)
      { userId: users[2].id, setId: aliceSet1.id, learned: 3, lastReviewed: new Date("2024-07-05") },
      { userId: users[3].id, setId: bobSet1.id, learned: 5, lastReviewed: new Date("2024-07-07") },
    ];

    for (const progress of progressData) {
      await prisma.flashcardProgress.create({ data: progress });
    }

    console.log(`‚úÖ Created ${progressData.length} progress records`);

    // Display summary
    console.log("\nüéâ Database seeding completed successfully!");
    console.log("\nüìä Summary:");
    console.log(`   üë• Users: ${users.length}`);
    console.log(`   üéì Courses: ${courses.length}`);
    console.log(`   üéØ Memberships: ${memberships.length}`);
    console.log(`   üìö Flashcard Sets: ${allSets.length}`);
    console.log(`   üìà Progress Records: ${progressData.length}`);
    
    console.log("\nüîë Demo Login Credentials:");
    console.log("   Email: alice@repit.com, bob@repit.com, charlie@repit.com, diana@repit.com");
    console.log("   Password: password123");

    console.log("\nüîó Test URLs:");
    console.log("   ‚Ä¢ Dashboard: http://localhost:3000/dashboard");
    console.log("   ‚Ä¢ Flashcards: http://localhost:3000/flashcards");
    console.log("   ‚Ä¢ Create Set: http://localhost:3000/flashcards/new");

  } catch (error) {
    console.error("‚ùå Error during seeding:", error);
    throw error;
  }
}

main()
  .catch((e) => {
    console.error("‚ùå Seeding failed:", e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
    console.log("üîå Database connection closed");
  });